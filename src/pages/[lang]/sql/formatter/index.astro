---
import BasePage from '../../../../components/BasePage.astro';
import BaseInputBlock from '../../../../components/BaseInputBlock.astro';
import BaseOutputBlock from '../../../../components/BaseOutputBlock.astro';
import BaseSettingBlock from '../../../../components/BaseSettingBlock.astro';
import { languages } from '../../../../i18n/ui';
import { useTranslations } from '../../../../i18n/utils';

export function getStaticPaths() {
  return Object.keys(languages).map((lang) => ({ params: { lang } }));
}

const { lang = 'en' } = Astro.params;
const t = useTranslations(lang as any);

// Page metadata
const title = t('sql_formatter.title');
const description = t('sql_formatter.description');
const activePage = 'sql/formatter';
---

<BasePage title={title} description={description} activePage={activePage}>
  <div class="layout">
    <div class="layout-block">
      <BaseInputBlock title={t('input')}>
        <textarea
          class="container"
          id="input"
          spellcheck="false"
          placeholder={t('sql_formatter.enter_query')}
          data-remember="input"
          data-share="input"
          data-auto-update
          data-toggle="monacoEditor"
          data-language="mysql"></textarea>
      </BaseInputBlock>

      <BaseOutputBlock title={t('output')} showCopy copyTarget="#output">
        <pre class="container syntax-highlight" id="output"><code class="sql" /></pre>
      </BaseOutputBlock>
    </div>

    <BaseSettingBlock title={t('settings')}>
      <div class="setting">
        <a class="btn" id="execute">{t('format')}</a>
      </div>

      <div class="setting">
        <label class="switcher">
          <input type="checkbox" id="auto-update" checked />
          <div class="toggle"></div>
          <span>{t('auto_update')}</span>
        </label>
      </div>

      <div class="setting">
        <label class="switcher">
          <input type="checkbox" id="remember-input" />
          <div class="toggle"></div>
          <span>{t('remember_input')}</span>
        </label>
      </div>

      <div class="setting">
        <label class="switcher">
          <input
            type="checkbox"
            id="uppercase-keywords"
            checked
            data-remember="uppercase-keywords"
          />
          <div class="toggle"></div>
          <span>{t('sql_formatter.uppercase_keywords')}</span>
        </label>
      </div>

      <div class="setting">
        <label for="indent-type">{t('sql_formatter.indent_type')}</label>
        <select id="indent-type" data-remember="indent-type">
          <option value="space" selected>Space</option>
          <option value="tab">Tab</option>
        </select>
      </div>

      <div class="setting">
        <label for="indent">{t('sql_formatter.indent')}</label>
        <input
          id="indent"
          type="number"
          value="2"
          step="1"
          min="1"
          max="10"
          data-remember="indent"
        />
      </div>
    </BaseSettingBlock>
  </div>

  <!-- Highlight.js stylesheet -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css"
  />

  <!-- SQL Formatter implementation -->
  <script is:inline>
    (function initSqlFormatter() {
      'use strict';

      /**
       * Get formatting options from UI controls
       * @returns {Object} SQL formatter options
       */
      function getFormatterOptions() {
        var indentEl = document.getElementById('indent');
        var indentTypeEl = document.getElementById('indent-type');
        var uppercaseEl = document.getElementById('uppercase-keywords');

        var indent = parseInt(indentEl?.value, 10) || 2;
        var indentType = indentTypeEl?.value || 'space';
        var uppercaseKeywords = uppercaseEl?.checked ?? true;

        return {
          language: 'sql',
          tabWidth: indentType === 'tab' ? 1 : indent,
          useTabs: indentType === 'tab',
          keywordCase: uppercaseKeywords ? 'upper' : 'preserve',
          indentStyle: 'standard',
          logicalOperatorNewline: 'before',
          expressionWidth: 50,
        };
      }

      /**
       * Apply syntax highlighting to code element
       * @param {HTMLElement} codeEl - Code element to highlight
       */
      function applyHighlighting(codeEl) {
        if (codeEl && typeof hljs !== 'undefined' && hljs.highlightElement) {
          hljs.highlightElement(codeEl);
        }
      }

      /**
       * Main SQL formatting function
       * @param {string} input - SQL query to format
       * @returns {string} Formatted SQL
       */
      window.method = function formatSql(input) {
        var codeEl = document.querySelector('#output code');

        // Handle empty input
        if (!input || typeof input !== 'string') {
          if (codeEl) codeEl.textContent = '';
          return '';
        }

        try {
          var options = getFormatterOptions();
          var formatted = input;

          // Format using sql-formatter library if available
          if (typeof sqlFormatter !== 'undefined' && sqlFormatter.format) {
            formatted = sqlFormatter.format(input, options);
          }

          // Update output and apply highlighting
          if (codeEl) {
            codeEl.textContent = formatted;
            codeEl.className = 'sql';
            applyHighlighting(codeEl);
          }

          return formatted;
        } catch (error) {
          console.error('SQL formatting error:', error);
          return input;
        }
      };

      // Signal that method is ready
      if (typeof methodLoad === 'function') {
        methodLoad();
      }
    })();
  </script>

  <!-- Load external libraries -->
  <script is:inline>
    ++waitLoadCount;
    ++waitLoadCount;
    delayScripts.push(
      {
        src: 'https://cdn.jsdelivr.net/npm/sql-formatter@15.4.7/dist/sql-formatter.min.js',
        onload: function () {
          methodLoad();
        },
      },
      {
        src: 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js',
        onload: function () {
          methodLoad();
        },
      }
    );
  </script>
</BasePage>
