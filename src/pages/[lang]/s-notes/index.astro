---
import BasePage from '../../../components/BasePage.astro';
import BaseInputBlock from '../../../components/BaseInputBlock.astro';
import BaseSettingBlock from '../../../components/BaseSettingBlock.astro';
import { languages } from '../../../i18n/ui';
import { useTranslations } from '../../../i18n/utils';

export function getStaticPaths() {
  return Object.keys(languages).map((lang) => ({ params: { lang } }));
}

const { lang } = Astro.params;
const t = useTranslations(lang as any);
---

<BasePage title={t('s_notes.title')} description={t('s_notes.description')} activePage="s-notes">
  <div class="layout">
    <div class="layout-block">
      <BaseInputBlock title={t('s_notes.note_content')}>
        <div class="notes-content-wrapper">
          <div id="note-editor" class="note-editor">
            <div id="editor-container"></div>
          </div>
          <div id="empty-state" class="empty-state">
            <p>{t('s_notes.no_notes')}</p>
          </div>
        </div>
      </BaseInputBlock>
    </div>
    <BaseSettingBlock title={t('s_notes.category')}>
      <div class="notes-sidebar-wrapper">
        <div class="notes-header">
          <div class="setting">
            <input
              type="text"
              id="search-notes"
              class="search-input"
              placeholder={t('s_notes.search_notes')}
            />
          </div>
          <div class="setting">
            <button id="new-note-btn" class="btn">{t('s_notes.new_note')}</button>
          </div>
          <div class="setting storage-info">
            <span id="storage-status" class="storage-status">
              <span class="status-dot"></span>
              <span class="status-text">{t('s_notes.loading')}</span>
            </span>
          </div>
        </div>
        <div id="notes-list" class="notes-list">
          <!-- Notes will be dynamically inserted here -->
        </div>
      </div>
    </BaseSettingBlock>
  </div>

  <script
    is:inline
    set:html={`
    window.notesTranslations = {
      untitled: ${JSON.stringify(t('s_notes.untitled'))},
      category: ${JSON.stringify(t('s_notes.category'))},
      confirmDelete: ${JSON.stringify(t('s_notes.confirm_delete'))},
      noNotes: ${JSON.stringify(t('s_notes.no_notes'))},
      loading: ${JSON.stringify(t('s_notes.loading') || 'Loading...')},
      ready: ${JSON.stringify(t('s_notes.ready') || 'Ready')},
      syncing: ${JSON.stringify(t('s_notes.syncing') || 'Syncing...')},
      error: ${JSON.stringify(t('s_notes.error') || 'Error')},
      attachments: ${JSON.stringify(t('s_notes.attachments') || 'Attachments')},
      deleteAttachment: ${JSON.stringify(t('s_notes.delete_attachment') || 'Delete attachment?')}
    };
  `}
  />

  <script is:inline>
    // Load Toast UI Editor CSS dynamically
    (function () {
      var cssFiles = [
        'https://uicdn.toast.com/editor/latest/toastui-editor.min.css',
        'https://uicdn.toast.com/editor/latest/theme/toastui-editor-dark.min.css',
      ];
      cssFiles.forEach(function (href) {
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = href;
        document.head.appendChild(link);
      });
    })();

    ++waitLoadCount;
    // Load Toast UI Editor JS
    delayScripts.push({
      src: 'https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js',
      onload: function () {
        // Then load our notes app
        var script = document.createElement('script');
        script.src = '/js/s-notes.js';
        script.onload = function () {
          methodLoad();
        };
        document.body.appendChild(script);
      },
    });
  </script>
</BasePage>

<style is:global>
  /* Notes Sidebar in Settings Block */
  .notes-sidebar-wrapper {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .notes-header {
    padding-bottom: 0.5rem;
  }

  .search-input {
    width: 100%;
    padding: 0.6rem 0.8rem;
    border: 1px solid var(--var-border-color);
    border-radius: 6px;
    font-size: 0.95rem;
    background: var(--var-input-bg-color);
    color: var(--var-input-color);
  }

  .search-input:focus {
    outline: none;
    border-color: var(--var-primary);
  }

  .storage-info {
    padding: 0.5rem 0;
  }

  .storage-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.8rem;
    color: var(--var-sidebar-link-color);
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--var-gray);
    transition: background 0.3s ease;
  }

  .storage-status.ready .status-dot {
    background: #22c55e;
  }

  .storage-status.syncing .status-dot {
    background: #f59e0b;
    animation: pulse 1s ease-in-out infinite;
  }

  .storage-status.error .status-dot {
    background: #ef4444;
  }

  @keyframes pulse {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }

  .notes-list {
    flex: 1;
    overflow-y: auto;
    margin: 0 -1rem;
    max-height: 450px;
    border-top: 1px solid var(--var-border-color);
  }

  .note-item {
    padding: 0.85rem 1rem;
    border-bottom: 1px solid var(--var-border-color);
    cursor: pointer;
    transition: all 0.15s ease;
    background: var(--var-main-bg-color);
    position: relative;
  }

  .note-item:hover {
    background: var(--var-title-bg-color);
    padding-left: 1.2rem;
  }

  .note-item.active {
    background: var(--var-primary);
    background: linear-gradient(135deg, var(--var-primary) 0%, var(--var-primary-dark) 100%);
    color: var(--var-white) !important;
    box-shadow: var(--var-shadow-md);
  }

  .note-item.active:hover {
    padding-left: 1rem;
    background: var(--var-primary-dark);
  }

  .note-item-title {
    font-weight: 600;
    font-size: 0.95rem;
    margin-bottom: 0.35rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    line-height: 1.3;
    color: var(--var-font-color);
  }

  .note-item.active .note-item-title {
    color: var(--var-white) !important;
  }

  .note-item-meta {
    font-size: 0.8rem;
    color: var(--var-sidebar-link-color);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    opacity: 0.8;
  }

  .note-item.active .note-item-meta {
    color: rgba(255, 255, 255, 0.85);
    opacity: 1;
  }

  .note-item-date {
    font-size: 0.75rem;
    opacity: 0.7;
  }

  .note-item-attachments {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.75rem;
  }

  .note-item-attachments::before {
    content: 'üìé';
  }

  .note-item-category {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    font-size: 0.8rem;
  }

  .note-item-category::before {
    content: 'üìÑ';
    font-size: 0.75rem;
  }

  .note-item.active .note-item-category::before {
    content: 'üìù';
  }

  /* Empty notes list */
  .notes-list:empty::after {
    content: 'No notes';
    display: block;
    text-align: center;
    padding: 2rem 1rem;
    color: var(--var-sidebar-link-color);
    font-size: 0.9rem;
  }

  /* Note Content in Input Block */
  .notes-content-wrapper {
    display: flex;
    flex-direction: column;
    height: 100%;
    min-height: 500px;
  }

  .note-editor {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .note-editor.hidden {
    display: none;
  }

  #editor-container {
    flex: 1;
    min-height: 450px;
  }

  /* Toast UI Editor Theme Override */
  .toastui-editor-defaultUI {
    border: none !important;
    border-radius: 0 !important;
  }

  .toastui-editor-defaultUI .toastui-editor-toolbar {
    background: var(--var-title-bg-color) !important;
    border-bottom: 1px solid var(--var-border-color) !important;
  }

  .toastui-editor-defaultUI .toastui-editor-toolbar-icons {
    color: var(--var-font-color) !important;
  }

  .toastui-editor-defaultUI .toastui-editor-toolbar-icons:hover {
    background: var(--var-primary) !important;
  }

  .toastui-editor-defaultUI .toastui-editor-mode-switch {
    background: var(--var-title-bg-color) !important;
    border-top: 1px solid var(--var-border-color) !important;
  }

  .toastui-editor-md-container,
  .toastui-editor-ww-container {
    background: var(--var-textarea-bg-color) !important;
  }

  .toastui-editor-contents {
    font-family: inherit !important;
    color: var(--var-font-color) !important;
  }

  .ProseMirror,
  .toastui-editor-md-preview {
    color: var(--var-font-color) !important;
  }

  /* Dark mode adjustments */
  [data-theme='dark'] .toastui-editor-defaultUI {
    border-color: var(--var-border-color) !important;
  }

  [data-theme='dark'] .toastui-editor-contents p,
  [data-theme='dark'] .toastui-editor-contents li,
  [data-theme='dark'] .ProseMirror p,
  [data-theme='dark'] .ProseMirror li {
    color: var(--var-font-color) !important;
  }

  [data-theme='dark'] .toastui-editor-md-code-block-line-background,
  [data-theme='dark'] .toastui-editor-contents pre {
    background: var(--var-bg-color) !important;
  }

  .empty-state {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--var-sidebar-link-color);
    font-size: 1.1rem;
    text-align: center;
    padding: 2rem;
    min-height: 400px;
  }

  .empty-state.hidden {
    display: none;
  }

  /* Scrollbar styling */
  .notes-list::-webkit-scrollbar {
    width: 8px;
  }

  .notes-list::-webkit-scrollbar-track {
    background: var(--var-bg-color);
  }

  .notes-list::-webkit-scrollbar-thumb {
    background: var(--var-border-color);
    border-radius: 4px;
  }

  .notes-list::-webkit-scrollbar-thumb:hover {
    background: var(--var-gray);
  }
</style>
