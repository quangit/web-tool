---
import BasePage from '../../../components/BasePage.astro';
import { languages } from '../../../i18n/ui';
import { useTranslations } from '../../../i18n/utils';

export function getStaticPaths() {
  return Object.keys(languages).map((lang) => ({ params: { lang } }));
}

const { lang } = Astro.params;
const t = useTranslations(lang as any);

// Pre-serialize translations at build time
const translations = {
  untitled: t('s_notes.untitled'),
  category: t('s_notes.category'),
  confirmDelete: t('s_notes.confirm_delete'),
  confirmDeleteWithChildren:
    t('s_notes.confirm_delete_with_children') ||
    'This note has child notes. Delete this note and all its children?',
  delete: t('s_notes.delete'),
  createChild: t('s_notes.create_child') || 'Create Note Item',
  addToFavorites: t('s_notes.add_to_favorites') || 'Add to Favorites',
  removeFromFavorites: t('s_notes.remove_from_favorites') || 'Remove from Favorites',
  noNotes: t('s_notes.no_notes'),
  noFavorites: t('s_notes.no_favorites') || 'No favorite notes yet',
  loading: t('s_notes.loading') || 'Loading...',
  ready: t('s_notes.ready') || 'Ready',
  syncing: t('s_notes.syncing') || 'Syncing...',
  error: t('s_notes.error') || 'Error',
  attachments: t('s_notes.attachments') || 'Attachments',
  deleteAttachment: t('s_notes.delete_attachment') || 'Delete attachment?',
  openInNewWindow: t('s_notes.detach') || 'Open in new window',
};

// WebApplication structured data for SEO
const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'WebApplication',
  name: t('s_notes.title'),
  description: t('s_notes.description'),
  applicationCategory: 'ProductivityApplication',
  operatingSystem: 'Any',
  browserRequirements: 'Requires JavaScript, IndexedDB support',
  offers: {
    '@type': 'Offer',
    price: '0',
    priceCurrency: 'USD',
  },
  featureList: [
    'Rich Markdown editing',
    'Image attachments with local storage',
    'Full-text search',
    'Hierarchical nested notes',
    'Favorites system',
    'Auto-save',
    'Privacy-focused - all data stored locally',
  ],
};
---

<BasePage title={t('s_notes.title')} description={t('s_notes.description')} activePage="s-notes">
  <!-- WebApplication Structured Data for SEO -->
  <script type="application/ld+json" set:html={JSON.stringify(structuredData)} slot="head-extra" />

  <div class="layout">
    <div class="layout-block">
      <div class="input">
        <div class="block block-fill">
          <div class="notes-content-wrapper">
            <div id="note-editor" class="note-editor">
              <div id="editor-container" aria-label={t('s_notes.note_content')}></div>
            </div>
            <div id="empty-state" class="empty-state" role="status" aria-live="polite">
              <p>{t('s_notes.no_notes')}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <aside class="settings" aria-label={t('s_notes.category')}>
      <div class="block block-fill">
        <div class="block-title">
          <span>{t('s_notes.category')}</span>
          <button id="new-note-btn" class="btn" aria-label={t('s_notes.new_note')}
            >{t('s_notes.new_note')}</button
          >
        </div>
        <div class="container">
          <div class="notes-sidebar-wrapper">
            <div class="notes-header">
              <div class="setting">
                <label for="search-notes" class="sr-only">{t('s_notes.search_notes')}</label>
                <input
                  type="search"
                  id="search-notes"
                  class="search-input"
                  placeholder={t('s_notes.search_notes')}
                  autocomplete="off"
                />
              </div>
              <nav class="notes-tabs" role="tablist" aria-label="Note filters">
                <button
                  class="notes-tab active"
                  data-tab="all"
                  id="tab-all"
                  role="tab"
                  aria-selected="true"
                  aria-controls="notes-list">{t('s_notes.tab_all') || 'All'}</button
                >
                <button
                  class="notes-tab"
                  data-tab="favorites"
                  id="tab-favorites"
                  role="tab"
                  aria-selected="false"
                  aria-controls="notes-list"
                >
                  <span class="tab-star" aria-hidden="true">‚≠ê</span>
                  {t('s_notes.tab_favorites') || 'Favorites'}
                </button>
              </nav>
              <div class="setting storage-info">
                <span id="storage-status" class="storage-status" role="status" aria-live="polite">
                  <span class="status-dot" aria-hidden="true"></span>
                  <span class="status-text">{t('s_notes.loading')}</span>
                </span>
              </div>
            </div>
            <div id="notes-list" class="notes-list" role="listbox" aria-label="Notes" tabindex="0">
              <!-- Notes will be dynamically inserted here -->
            </div>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <!-- Inline critical styles for faster FCP -->
  <style>
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* Critical above-the-fold styles */
    .notes-content-wrapper {
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 500px;
    }

    .note-editor {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .note-editor.hidden {
      display: none;
    }

    #editor-container {
      flex: 1;
      min-height: 450px;
    }

    .empty-state {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--var-sidebar-link-color);
      font-size: 1.1rem;
      text-align: center;
      padding: 2rem;
      min-height: 400px;
    }

    .empty-state.hidden {
      display: none;
    }
  </style>

  <!-- Translations passed via define:vars for better parsing -->
  <script define:vars={{ translations }}>
    window.notesTranslations = translations;
  </script>

  <!-- Non-critical CSS loaded asynchronously -->
  <script>
    import '../../../styles/s-notes.css';
    import '../../../scripts/s-notes.js';
  </script>
</BasePage>
