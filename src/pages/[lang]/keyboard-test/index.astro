---
import BasePage from '../../../components/BasePage.astro';
import BaseSettingBlock from '../../../components/BaseSettingBlock.astro';
import { languages } from '../../../i18n/ui';
import { useTranslations } from '../../../i18n/utils';

export function getStaticPaths() {
  return Object.keys(languages).map((lang) => {
    return { params: { lang } };
  });
}

const { lang } = Astro.params;
const t = useTranslations(lang as any);

// Keyboard layout definition
const rows = [
  [
    { code: 'Escape', label: 'Esc', width: 2 },
    { code: 'F1', label: 'F1' },
    { code: 'F2', label: 'F2' },
    { code: 'F3', label: 'F3' },
    { code: 'F4', label: 'F4' },
    { code: 'F5', label: 'F5' },
    { code: 'F6', label: 'F6' },
    { code: 'F7', label: 'F7' },
    { code: 'F8', label: 'F8' },
    { code: 'F9', label: 'F9' },
    { code: 'F10', label: 'F10' },
    { code: 'F11', label: 'F11' },
    { code: 'F12', label: 'F12' },
    { code: 'PrintScreen', label: 'PrtSc' },
    { code: 'ScrollLock', label: 'ScrLk' },
    { code: 'Pause', label: 'Pause' },
  ],
  [
    { code: 'Backquote', label: '`' },
    { code: 'Digit1', label: '1' },
    { code: 'Digit2', label: '2' },
    { code: 'Digit3', label: '3' },
    { code: 'Digit4', label: '4' },
    { code: 'Digit5', label: '5' },
    { code: 'Digit6', label: '6' },
    { code: 'Digit7', label: '7' },
    { code: 'Digit8', label: '8' },
    { code: 'Digit9', label: '9' },
    { code: 'Digit0', label: '0' },
    { code: 'Minus', label: '-' },
    { code: 'Equal', label: '=' },
    { code: 'Backspace', label: 'Backspace', width: 3 },
    { code: 'Insert', label: 'Ins' },
    { code: 'Home', label: 'Home' },
    { code: 'PageUp', label: 'PgUp' },
    { code: 'NumLock', label: 'Num' },
    { code: 'NumpadDivide', label: '/' },
    { code: 'NumpadMultiply', label: '*' },
    { code: 'NumpadSubtract', label: '-' },
  ],
  [
    { code: 'Tab', label: 'Tab', width: 2 },
    { code: 'KeyQ', label: 'Q' },
    { code: 'KeyW', label: 'W' },
    { code: 'KeyE', label: 'E' },
    { code: 'KeyR', label: 'R' },
    { code: 'KeyT', label: 'T' },
    { code: 'KeyY', label: 'Y' },
    { code: 'KeyU', label: 'U' },
    { code: 'KeyI', label: 'I' },
    { code: 'KeyO', label: 'O' },
    { code: 'KeyP', label: 'P' },
    { code: 'BracketLeft', label: '[' },
    { code: 'BracketRight', label: ']' },
    { code: 'Backslash', label: '\\', width: 2 },
    { code: 'Delete', label: 'Del' },
    { code: 'End', label: 'End' },
    { code: 'PageDown', label: 'PgDn' },
    { code: 'Numpad7', label: '7' },
    { code: 'Numpad8', label: '8' },
    { code: 'Numpad9', label: '9' },
    { code: 'NumpadAdd', label: '+', height: 2 },
  ],
  [
    { code: 'CapsLock', label: 'Caps', width: 2.5 },
    { code: 'KeyA', label: 'A' },
    { code: 'KeyS', label: 'S' },
    { code: 'KeyD', label: 'D' },
    { code: 'KeyF', label: 'F' },
    { code: 'KeyG', label: 'G' },
    { code: 'KeyH', label: 'H' },
    { code: 'KeyJ', label: 'J' },
    { code: 'KeyK', label: 'K' },
    { code: 'KeyL', label: 'L' },
    { code: 'Semicolon', label: ';' },
    { code: 'Quote', label: "'" },
    { code: 'Enter', label: 'Enter', width: 3.5 },
    { code: 'Spacer', label: '', width: 3, invisible: true }, // Spacer
    { code: 'Numpad4', label: '4' },
    { code: 'Numpad5', label: '5' },
    { code: 'Numpad6', label: '6' },
  ],
  [
    { code: 'ShiftLeft', label: 'Shift', width: 3 },
    { code: 'KeyZ', label: 'Z' },
    { code: 'KeyX', label: 'X' },
    { code: 'KeyC', label: 'C' },
    { code: 'KeyV', label: 'V' },
    { code: 'KeyB', label: 'B' },
    { code: 'KeyN', label: 'N' },
    { code: 'KeyM', label: 'M' },
    { code: 'Comma', label: ',' },
    { code: 'Period', label: '.' },
    { code: 'Slash', label: '/' },
    { code: 'ShiftRight', label: 'Shift', width: 4 },
    { code: 'Spacer', label: '', width: 1, invisible: true },
    { code: 'ArrowUp', label: '↑' },
    { code: 'Spacer', label: '', width: 1, invisible: true },
    { code: 'Numpad1', label: '1' },
    { code: 'Numpad2', label: '2' },
    { code: 'Numpad3', label: '3' },
    { code: 'NumpadEnter', label: 'Ent', height: 2 },
  ],
  [
    { code: 'ControlLeft', label: 'Ctrl', width: 1.5 },
    { code: 'MetaLeft', label: 'Win', width: 1.5 },
    { code: 'AltLeft', label: 'Alt', width: 1.5 },
    { code: 'Space', label: 'Space', width: 10 },
    { code: 'AltRight', label: 'Alt', width: 1.5 },
    { code: 'MetaRight', label: 'Win', width: 1.5 },
    { code: 'ContextMenu', label: 'Menu', width: 1.5 },
    { code: 'ControlRight', label: 'Ctrl', width: 1.5 },
    { code: 'ArrowLeft', label: '←' },
    { code: 'ArrowDown', label: '↓' },
    { code: 'ArrowRight', label: '→' },
    { code: 'Numpad0', label: '0', width: 2 },
    { code: 'NumpadDecimal', label: '.' },
  ]
];

// Helper to calculate width
const baseWidth = 40;
const gap = 5;
const getKeyStyle = (key: any) => {
    const w = key.width || 1;
    const widthPx = baseWidth * w + (w - 1) * gap;
    let style = `width: ${widthPx}px;`;
    if (key.invisible) style += 'visibility: hidden;';
    return style;
};
---

<BasePage
  title={t('keyboard_test.title')}
  description={t('keyboard_test.description')}
  activePage="keyboard-test"
>
  <div class="layout">
    <div class="layout-block" style="flex: 1; min-width: 0;">
        <div class="keyboard-wrapper">
            <div id="keyboard" class="keyboard">
                {rows.map((row) => (
                    <div class="row">
                        {row.map((key) => (
                            <div
                                class="key"
                                data-code={key.code}
                                style={getKeyStyle(key)}
                            >
                                {key.label}
                            </div>
                        ))}
                    </div>
                ))}
            </div>

            <div class="key-info">
                <div class="info-box">
                    <span class="label">{t('keyboard_test.key_code')}</span>
                    <span id="key-code" class="value">-</span>
                </div>
                <div class="info-box">
                    <span class="label">{t('keyboard_test.key_name')}</span>
                    <span id="key-name" class="value">-</span>
                </div>
                <div class="info-box">
                    <span class="label">{t('keyboard_test.key_location')}</span>
                    <span id="key-location" class="value">-</span>
                </div>
            </div>

            <div class="actions">
                 <button id="reset-btn" class="btn-reset">{t('keyboard_test.reset')}</button>
            </div>
        </div>
    </div>

    <BaseSettingBlock title={t('settings')}>
         <div class="setting">
            <label class="switcher">
              <input type="checkbox" id="sound-enabled" checked />
              <div class="toggle"></div>
              <span>{t('calculator.sound')}</span>
            </label>
        </div>
    </BaseSettingBlock>
  </div>

  <style>
    .keyboard-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2rem;
        padding: 2rem;
        background: var(--bg-card);
        border-radius: 8px;
        box-shadow: var(--shadow-sm);
        /* Ensure it doesn't overflow parent in a bad way, allow scroll if really needed */
        width: 100%;
        overflow-x: auto;
    }

    .keyboard {
        display: flex;
        flex-direction: column;
        gap: 5px;
        padding: 15px;
        background: #2d3748;
        border-radius: 12px;
        user-select: none;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        margin: 0 auto; /* Center in wrapper */
    }

    .row {
        display: flex;
        gap: 5px;
        justify-content: center; /* Center rows */
        flex-wrap: nowrap; /* Prevent wrapping which breaks layout */
    }

    .key {
        background: #4a5568;
        color: #fff;
        border-radius: 6px;
        padding: 0 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: default;
        transition: all 0.1s ease;
        font-size: 0.85rem;
        font-weight: 600;
        height: 40px;
        box-shadow: 0 2px 0 rgba(0,0,0,0.2);
        white-space: nowrap;
        overflow: hidden;
        flex-shrink: 0; /* Don't shrink keys */
    }

    /* Active state (currently pressed) */
    .key.active {
        background: #48bb78; /* Green */
        transform: translateY(2px);
        box-shadow: none;
        color: white;
    }

    /* Pressed history state (was pressed) */
    .key.pressed {
        background: #38a169; /* Darker Green */
        color: white;
        border: 2px solid #9ae6b4;
    }

    .key.active.pressed {
        background: #48bb78; /* Keep bright green when holding */
    }

    .key-info {
        display: flex;
        gap: 1.5rem;
        flex-wrap: wrap;
        justify-content: center;
        width: 100%;
    }

    .info-box {
        background: var(--bg-input);
        padding: 1rem 1.5rem;
        border-radius: 8px;
        min-width: 140px;
        text-align: center;
        border: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .info-box .label {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
    }

    .info-box .value {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-main);
        font-family: monospace;
    }

    .actions {
        display: flex;
        justify-content: center;
    }

    .btn-reset {
        padding: 0.75rem 2rem;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
    }

    .btn-reset:hover {
        background-color: var(--primary-hover);
    }

    .btn-reset:active {
        transform: translateY(1px);
    }
  </style>

  <script>
    const keyCodeEl = document.getElementById('key-code');
    const keyNameEl = document.getElementById('key-name');
    const keyLocationEl = document.getElementById('key-location');
    const resetBtn = document.getElementById('reset-btn');
    const soundEnabled = document.getElementById('sound-enabled') as HTMLInputElement;

    // Initialize AudioContext once
    let audioCtx: AudioContext | null = null;

    function getAudioContext() {
        if (!audioCtx) {
            const AudioContext = window.AudioContext || (window as any).webkitAudioContext;
            if (AudioContext) {
                audioCtx = new AudioContext();
            }
        }
        return audioCtx;
    }

    function handleKeyDown(e: KeyboardEvent) {
        e.preventDefault();
        const code = e.code;
        const key = e.key;
        const location = e.location; // 0: Standard, 1: Left, 2: Right, 3: Numpad

        // Update Info
        if (keyCodeEl) keyCodeEl.textContent = code;
        if (keyNameEl) keyNameEl.textContent = key === ' ' ? 'Space' : key;

        let locText = 'Standard';
        if (location === 1) locText = 'Left';
        if (location === 2) locText = 'Right';
        if (location === 3) locText = 'Numpad';
        if (keyLocationEl) keyLocationEl.textContent = locText;

        // Visual Feedback
        const keyEl = document.querySelector(`.key[data-code="${code}"]`);
        if (keyEl) {
            keyEl.classList.add('active');
            keyEl.classList.add('pressed');
        }

        playSound();
    }

    function handleKeyUp(e: KeyboardEvent) {
        e.preventDefault();
        const code = e.code;
        const keyEl = document.querySelector(`.key[data-code="${code}"]`);
        if (keyEl) {
            keyEl.classList.remove('active');
        }
    }

    function playSound() {
        if (soundEnabled && soundEnabled.checked) {
             try {
                 const ctx = getAudioContext();
                 if (ctx) {
                     // Resume context if suspended (browser policy)
                     if (ctx.state === 'suspended') {
                         ctx.resume();
                     }

                     const osc = ctx.createOscillator();
                     const gain = ctx.createGain();

                     osc.type = 'sine';
                     osc.frequency.setValueAtTime(440, ctx.currentTime);
                     osc.frequency.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);

                     gain.gain.setValueAtTime(0.1, ctx.currentTime);
                     gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.1);

                     osc.connect(gain);
                     gain.connect(ctx.destination);

                     osc.start();
                     osc.stop(ctx.currentTime + 0.1);
                 }
             } catch (err) {
                 console.error("Audio error", err);
             }
        }
    }

    // Add event listeners
    window.addEventListener('keydown', handleKeyDown);
    window.addEventListener('keyup', handleKeyUp);

    if (resetBtn) {
        resetBtn.addEventListener('click', () => {
            document.querySelectorAll('.key').forEach(el => {
                el.classList.remove('pressed');
                el.classList.remove('active');
            });
            if (keyCodeEl) keyCodeEl.textContent = '-';
            if (keyNameEl) keyNameEl.textContent = '-';
            if (keyLocationEl) keyLocationEl.textContent = '-';
        });
    }
  </script>
</BasePage>
