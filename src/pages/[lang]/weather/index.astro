---
import BasePage from '../../../components/BasePage.astro';
import BaseSettingBlock from '../../../components/BaseSettingBlock.astro';
import { languages } from '../../../i18n/ui';
import { useTranslations } from '../../../i18n/utils';
import '../../../styles/weather.css';

export function getStaticPaths() {
  return Object.keys(languages).map((lang) => {
    return { params: { lang } };
  });
}

const { lang = 'en' } = Astro.params;
const t = useTranslations(lang as any);

const title = t('weather.title');
const description = t('weather.description');
const activePage = 'weather';
---

<BasePage title={title} description={description} activePage={activePage}>
  <div class="layout">
    <div class="layout-block" style="flex: 1;">
      <div class="weather-container">
        <!-- Header with refresh button -->
        <div class="weather-header">
          <h3>{t('weather.selected_cities')}</h3>
          <button class="refresh-btn" id="refresh-weather">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
              <path d="M3 3v5h5"></path>
              <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"></path>
              <path d="M16 16h5v5"></path>
            </svg>
            {t('weather.refresh')}
          </button>
        </div>

        <!-- Weather Cards -->
        <div class="weather-cards-section">
          <div class="weather-cards-grid" id="weather-cards-container">
            <!-- Weather cards will be rendered here -->
          </div>
        </div>

        <!-- Search Input -->
        <div class="city-search-container">
          <svg
            class="search-icon"
            xmlns="http://www.w3.org/2000/svg"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
          <input
            type="text"
            id="city-search"
            class="city-search-input"
            placeholder={t('weather.search_placeholder')}
          />
        </div>

        <!-- Available Cities -->
        <div class="available-cities-section">
          <div class="section-title">{t('weather.available_cities')}</div>
          <div class="available-cities-list" id="available-cities-container">
            <!-- Available cities will be rendered here -->
          </div>
        </div>
      </div>
    </div>

    <BaseSettingBlock title={t('settings')}>
      <div class="setting">
        <p style="font-size: 0.875rem; color: var(--text-secondary);">
          {t('weather.help_text')}
        </p>
      </div>
    </BaseSettingBlock>
  </div>

  <script
    is:inline
    define:vars={{
      t_loading: t('weather.loading'),
      t_error: t('weather.error'),
      t_noResults: t('weather.no_results'),
      t_yourLocation: t('weather.your_location'),
      t_locationError: t('weather.location_error'),
      t_temperature: t('weather.temperature'),
      t_windSpeed: t('weather.wind_speed'),
      t_humidity: t('weather.humidity'),
      t_feelsLike: t('weather.feels_like'),
      t_selectCities: t('weather.select_cities'),
      t_selectedCities: t('weather.selected_cities'),
      t_availableCities: t('weather.available_cities'),
      t_lastUpdated: t('weather.last_updated'),
      t_refresh: t('weather.refresh'),
      t_locale: lang,
    }}
  >
    window.weatherTranslations = {
      loading: t_loading,
      error: t_error,
      noResults: t_noResults,
      yourLocation: t_yourLocation,
      locationError: t_locationError,
      temperature: t_temperature,
      windSpeed: t_windSpeed,
      humidity: t_humidity,
      feelsLike: t_feelsLike,
      selectCities: t_selectCities,
      selectedCities: t_selectedCities,
      availableCities: t_availableCities,
      lastUpdated: t_lastUpdated,
      refresh: t_refresh,
      locale: t_locale,
    };
  </script>

  <script>
    import { initWeather } from '../../../scripts/weather';

    declare global {
      interface Window {
        weatherTranslations: {
          loading: string;
          error: string;
          noResults: string;
          yourLocation: string;
          locationError: string;
          temperature: string;
          windSpeed: string;
          humidity: string;
          feelsLike: string;
          selectCities: string;
          selectedCities: string;
          availableCities: string;
          lastUpdated: string;
          refresh: string;
          locale: string;
        };
      }
    }

    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        initWeather(window.weatherTranslations);
      });
    } else {
      initWeather(window.weatherTranslations);
    }
  </script>
</BasePage>
