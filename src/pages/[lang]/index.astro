---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Sidebar from '../../components/Sidebar.astro';
import PageHeader from '../../components/PageHeader.astro';
import { toolSections } from '../../data/toolSections';
import { languages } from '../../i18n/ui';
import { useTranslations } from '../../i18n/utils';

export function getStaticPaths() {
  return Object.keys(languages).map((lang) => ({ params: { lang } }));
}

const { lang = 'en' } = Astro.params;
const t = useTranslations(lang as any);

// i18n data for client-side scripts
const i18nData = {
  noResult: t('sidebar.search.no_result'),
  found: t('sidebar.search.found'),
  empty: t('sidebar.my_tools.empty'),
  lang,
};
---

<BaseLayout title={t('sidebar.title')} description={t('sidebar.description')}>
  <div id="app">
    <Sidebar />
    <div id="content">
      <div class="top-nav">
        <button
          id="sidebar-toggler"
          aria-controls="sidebar"
          aria-expanded="false"
          aria-label={t('sidebar.toggle_menu')}
        >
          <i data-lucide="menu"></i>
        </button>
      </div>
      <PageHeader title={t('sidebar.title')} description={t('sidebar.description')} />

      <main>
        <div id="index">
          <!-- My Tools Card -->
          <div class="section" id="my-tools-card">
            <h2>{t('sidebar.my_tools')}</h2>
            <ol id="favorite-tools-list" class="blocks">
              <li class="empty-state">{t('sidebar.my_tools.empty')}</li>
            </ol>
          </div>

          <hr />

          <!-- Search Box -->
          <div class="section" id="search-section">
            <div class="search-container">
              <input
                type="text"
                id="tool-search"
                placeholder={t('sidebar.search')}
                autocomplete="off"
              />
              <div id="search-results-count"></div>
            </div>
          </div>

          <!-- Tool Sections -->
          {
            toolSections.map((section) => (
              <div class="section" data-section={section.title.toLowerCase().replace(/\s+/g, '-')}>
                <h2 class="section-title">
                  <button class="section-toggle" type="button" aria-expanded="true">
                    <svg
                      class="section-arrow"
                      width="12"
                      height="12"
                      viewBox="0 0 12 12"
                      fill="none"
                      aria-hidden="true"
                    >
                      <path
                        d="M3 5L6 8L9 5"
                        stroke="currentColor"
                        stroke-width="1.5"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                    <span>{section.title}</span>
                  </button>
                </h2>
                <div class="section-content">
                  <div class="blocks">
                    {section.blocks.map((block) => (
                      <div class="block">
                        <h3>{block.title}</h3>
                        <nav>
                          <ol>
                            {block.items.map((item) => (
                              <li>
                                <a href={`/${lang}/${item.url}`}>
                                  {item.icon && <i data-lucide={item.icon} class="tool-icon" />}
                                  <span>{item.name}</span>
                                </a>
                              </li>
                            ))}
                          </ol>
                        </nav>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            ))
          }
        </div>
      </main>
    </div>
    <div id="message"></div>

    <!-- i18n data for client-side scripts -->
    <script is:inline id="i18n-data" type="application/json" set:html={JSON.stringify(i18nData)} />
  </div>

  <script>
    // ============================================
    // Types & Constants
    // ============================================
    interface FavoriteItem {
      url: string;
      title: string;
      icon: string;
    }

    interface I18nData {
      noResult: string;
      found: string;
      empty: string;
      lang: string;
    }

    const FAVORITES_KEY = 'favorite-tools';
    const SECTIONS_STATE_KEY = 'index-sections-state';

    // ============================================
    // Utility Functions
    // ============================================
    function getI18nData(): I18nData {
      const script = document.getElementById('i18n-data');
      if (!script?.textContent) {
        return { noResult: 'No tools found', found: 'Found {0} tool{1}', empty: '', lang: 'en' };
      }
      return JSON.parse(script.textContent);
    }

    function getFavorites(): FavoriteItem[] {
      try {
        return JSON.parse(localStorage.getItem(FAVORITES_KEY) || '[]');
      } catch {
        return [];
      }
    }

    function saveFavorites(favorites: FavoriteItem[]): void {
      localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites));
    }

    function getSectionStates(): Record<string, boolean> {
      try {
        return JSON.parse(localStorage.getItem(SECTIONS_STATE_KEY) || '{}');
      } catch {
        return {};
      }
    }

    function saveSectionState(sectionId: string, isExpanded: boolean): void {
      const states = getSectionStates();
      states[sectionId] = isExpanded;
      localStorage.setItem(SECTIONS_STATE_KEY, JSON.stringify(states));
    }

    // ============================================
    // Favorites Module
    // ============================================
    function initFavorites(): void {
      const i18n = getI18nData();
      const list = document.getElementById('favorite-tools-list');

      function toggleFavorite(url: string, title: string, icon: string): void {
        const favorites = getFavorites();
        const index = favorites.findIndex((f) => f.url === url);

        if (index > -1) {
          favorites.splice(index, 1);
        } else {
          favorites.push({ url, title, icon });
        }

        saveFavorites(favorites);
        updateFavoritesList();
        updateHeartIcons();
      }

      function updateFavoritesList(): void {
        if (!list) return;

        const favorites = getFavorites();

        if (favorites.length === 0) {
          list.innerHTML = `<li class="empty-state">${i18n.empty}</li>`;
          return;
        }

        list.innerHTML = favorites
          .map(
            (fav) => `
              <li>
                <a href="/${i18n.lang}/${fav.url}">
                  ${fav.icon ? `<i data-lucide="${fav.icon}" class="tool-icon"></i>` : ''}
                  <span>${fav.title}</span>
                </a>
                <span
                  class="favorite-toggle active"
                  data-url="${fav.url}"
                  data-title="${fav.title}"
                  data-icon="${fav.icon || ''}"
                ></span>
              </li>
            `
          )
          .join('');

        // Re-initialize Lucide icons after DOM update
        requestAnimationFrame(() => {
          // eslint-disable-next-line @typescript-eslint/no-explicit-any
          const lucide = (window as any).lucide;
          if (lucide) {
            lucide.createIcons();
          }
        });

        // Attach event listeners to favorite toggles
        list.querySelectorAll<HTMLElement>('.favorite-toggle').forEach((toggle) => {
          toggle.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            toggleFavorite(
              toggle.dataset.url || '',
              toggle.dataset.title || '',
              toggle.dataset.icon || ''
            );
          });
        });
      }

      function updateHeartIcons(): void {
        const favoriteUrls = getFavorites().map((f) => f.url);

        document.querySelectorAll<HTMLElement>('#index .favorite-toggle').forEach((toggle) => {
          const isFavorite = favoriteUrls.includes(toggle.dataset.url || '');
          toggle.classList.toggle('active', isFavorite);
        });
      }

      // Add heart icons to all tool links (except in My Tools card)
      document
        .querySelectorAll<HTMLElement>('#index .section:not(#my-tools-card) li')
        .forEach((li) => {
          const link = li.querySelector<HTMLAnchorElement>('a');
          if (!link) return;

          const rawUrl = new URL(link.href).pathname;
          const url = rawUrl.startsWith(`/${i18n.lang}/`)
            ? rawUrl.substring(`/${i18n.lang}/`.length)
            : rawUrl.substring(1);

          const itemName = link.querySelector('span')?.textContent || link.textContent || '';
          // Look for both original <i> element and rendered <svg> by lucide
          const iconElement =
            link.querySelector<HTMLElement>('i[data-lucide]') ||
            link.querySelector<HTMLElement>('svg[data-lucide]') ||
            link.querySelector<HTMLElement>('.lucide');
          const icon = iconElement?.getAttribute('data-lucide') || '';

          // Get category from the block's h3 element
          const block = li.closest('.block');
          const category = block?.querySelector('h3')?.textContent || '';
          const title = category ? `${category}: ${itemName}` : itemName;

          const heart = document.createElement('span');
          heart.className = 'favorite-toggle';
          heart.dataset.url = url;
          heart.dataset.title = title;
          heart.dataset.icon = icon;

          heart.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            toggleFavorite(url, title, icon);
          });

          li.appendChild(heart);
        });

      updateFavoritesList();
      updateHeartIcons();
    }

    // ============================================
    // Search Module
    // ============================================
    function initSearch(): void {
      const i18n = getI18nData();
      const searchInput = document.getElementById('tool-search') as HTMLInputElement | null;
      const resultsCount = document.getElementById('search-results-count');
      const allSections = document.querySelectorAll<HTMLElement>(
        '#index .section:not(#my-tools-card):not(#search-section)'
      );

      if (!searchInput || !resultsCount) return;

      function performSearch(): void {
        const searchTerm = searchInput!.value.toLowerCase().trim();
        let totalVisible = 0;

        if (!searchTerm) {
          // Show all sections, blocks, and items
          allSections.forEach((section) => {
            section.style.display = '';
            section.querySelectorAll<HTMLElement>('.block').forEach((block) => {
              block.style.display = '';
              block.querySelectorAll<HTMLElement>('li').forEach((item) => {
                item.style.display = '';
              });
            });
          });
          resultsCount!.textContent = '';
          return;
        }

        // Filter sections and items
        allSections.forEach((section) => {
          const sectionTitle = section.querySelector('h2')?.textContent?.toLowerCase() || '';
          let sectionHasVisibleItems = false;

          section.querySelectorAll<HTMLElement>('.block').forEach((block) => {
            const blockTitle = block.querySelector('h3')?.textContent?.toLowerCase() || '';
            let blockHasVisibleItems = false;

            block.querySelectorAll<HTMLElement>('li').forEach((item) => {
              const link = item.querySelector('a');
              if (!link) return;

              const toolName = link.textContent?.toLowerCase() || '';
              const isMatch =
                toolName.includes(searchTerm) ||
                blockTitle.includes(searchTerm) ||
                sectionTitle.includes(searchTerm);

              if (isMatch) {
                item.style.display = '';
                blockHasVisibleItems = true;
                sectionHasVisibleItems = true;
                totalVisible++;
              } else {
                item.style.display = 'none';
              }
            });

            block.style.display = blockHasVisibleItems ? '' : 'none';
          });

          section.style.display = sectionHasVisibleItems ? '' : 'none';
        });

        // Update results count
        if (totalVisible === 0) {
          resultsCount!.innerHTML = `<span style="color: var(--var-red);">${i18n.noResult}</span>`;
        } else {
          const text = i18n.found
            .replace('{0}', String(totalVisible))
            .replace('{1}', totalVisible !== 1 ? 's' : '');
          resultsCount!.innerHTML = `<span style="color: var(--var-primary);">${text}</span>`;
        }
      }

      searchInput.addEventListener('input', performSearch);

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        // Focus search on Ctrl+K or Cmd+K
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
          e.preventDefault();
          searchInput.focus();
        }

        // Clear search on Escape
        if (e.key === 'Escape' && document.activeElement === searchInput) {
          searchInput.value = '';
          performSearch();
          searchInput.blur();
        }
      });
    }

    // ============================================
    // Section Collapse Module
    // ============================================
    function initSectionToggle(): void {
      const sections = document.querySelectorAll<HTMLElement>('#index .section[data-section]');
      const savedStates = getSectionStates();

      sections.forEach((section) => {
        const sectionId = section.dataset.section;
        const toggleBtn = section.querySelector<HTMLButtonElement>('.section-toggle');
        const content = section.querySelector<HTMLElement>('.section-content');

        if (!toggleBtn || !content || !sectionId) return;

        // Apply saved state or default to expanded
        const isExpanded = savedStates[sectionId] !== false;
        toggleBtn.setAttribute('aria-expanded', String(isExpanded));
        if (!isExpanded) {
          content.style.display = 'none';
        }

        toggleBtn.addEventListener('click', () => {
          const currentState = toggleBtn.getAttribute('aria-expanded') === 'true';
          const newState = !currentState;

          toggleBtn.setAttribute('aria-expanded', String(newState));
          content.style.display = newState ? '' : 'none';
          saveSectionState(sectionId, newState);
        });
      });
    }

    // ============================================
    // Initialize All Modules
    // ============================================
    document.addEventListener('DOMContentLoaded', () => {
      initFavorites();
      initSearch();
      initSectionToggle();
    });
  </script>

  <style is:inline>
    #index .section-title {
      margin-top: 16px;
      margin-bottom: 0;
      padding: 0;
    }

    #index .section-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      padding: 0;
      background: none;
      border: none;
      font-size: 24px;
      font-weight: 600;
      color: var(--text-primary);
      cursor: pointer;
      text-align: left;
      transition: opacity 0.2s;
      margin-bottom: 16px;
    }

    #index .section-toggle:hover {
      opacity: 0.7;
    }

    #index .section-arrow {
      flex-shrink: 0;
      transition: transform 0.2s;
    }

    #index .section-toggle[aria-expanded='false'] .section-arrow {
      transform: rotate(-90deg);
    }

    #index .section-content {
      transition: opacity 0.2s;
    }

    /* Icon styles */
    .tool-icon {
      width: 16px;
      height: 16px;
      margin-right: 8px;
      vertical-align: middle;
      display: inline-block;
    }

    #index li a {
      display: flex;
      align-items: center;
    }

    /* Favorites List Styles */
    #favorite-tools-list {
      /* Grid layout inherited from .blocks class */
      padding: 0;
      margin: 0;
      list-style: none;
    }

    #index #favorite-tools-list li {
      background-color: var(--var-main-bg-color);
      border: 1px solid var(--var-border-color);
      border-radius: 8px;
      padding: 8px 12px;
      position: relative;
      display: flex;
      align-items: center;
      box-shadow: var(--var-shadow-sm);
      transition: all 0.2s ease;
    }

    #index #favorite-tools-list li:hover {
      transform: translateY(-2px);
      box-shadow: var(--var-shadow-md);
      border-color: var(--var-primary);
    }

    #index #favorite-tools-list li a {
      width: 100%;
      padding: 4px 0;
      padding-right: 24px;
      display: flex;
      align-items: center;
      color: var(--var-font-color);
    }

    #index #favorite-tools-list li a:hover {
      background-color: transparent;
      transform: none;
      padding-left: 0;
      padding-right: 24px;
      color: var(--var-primary);
    }

    #index #favorite-tools-list .empty-state {
      grid-column: 1 / -1;
      width: 100%;
      text-align: center;
      background: none !important;
      border: 2px dashed var(--var-border-color) !important;
      box-shadow: none !important;
      padding: 2rem;
      color: var(--var-gray-500);
      cursor: default;
    }

    #index #favorite-tools-list .empty-state:hover {
      transform: none;
      border-color: var(--var-border-color) !important;
    }
  </style>
</BaseLayout>
