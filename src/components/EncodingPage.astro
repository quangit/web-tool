---
import BaseLayout from '../layouts/BaseLayout.astro';
import Sidebar from './Sidebar.astro';
import PageHeader from './PageHeader.astro';
import InputEncodingSelect from './InputEncodingSelect.astro';
import OutputEncodingSelect from './OutputEncodingSelect2.astro';
import InputBlock from './InputBlock.astro';
import InputFileBlock from './InputFileBlock.astro';
import OutputBlock from './OutputBlock.astro';
import SettingBlock from './SettingBlock.astro';

interface Props {
    title: string;
    description: string;
    toolName: string;
    jsFile: string;
    activePage: string;
    reverseLink: string;
    hasInputSettings?: boolean;
    hasOutputSettings?: boolean;
    hasFormatSettings?: boolean;
    initScript?: string;
    extraJsFile?: string;
    outputDataType?: string;
    // File input support
    hasFileInput?: boolean;
    inputFileUrlPlaceholder?: string;
    inputFileDropText?: string;
    // Editor language
    editorLanguage?: string;
    hasOutputTextarea?: boolean;
    outputToggleMonaco?: boolean;
    loadMonaco?: boolean;
    outputPlaceholder?: string;
}

const { 
    title, 
    description, 
    toolName, 
    jsFile, 
    activePage, 
    reverseLink, 
    hasInputSettings = true, 
    hasOutputSettings = false, 
    hasFormatSettings = false, 
    initScript, 
    extraJsFile, 
    outputDataType,
    hasFileInput = false,
    inputFileUrlPlaceholder,
    inputFileDropText,
    editorLanguage,
    hasOutputTextarea = true,
    outputToggleMonaco = true,
    loadMonaco = true,
    outputPlaceholder
} = Astro.props;
---

<BaseLayout title={title} description={description}>
    <div id="app">
        <Sidebar activePage={activePage} />
        
        <div id="content">
            <div class="top-nav">
                <button id="sidebar-toggler" aria-controls="sidebar" aria-expanded="false" aria-label="Menu">
                    <img src="/images/menu.svg" width="24" height="24" alt="Menu">
                </button>
            </div>
            
            <PageHeader title={title} description={description} />
            
            <main>
                <div class="layout">
                    <div class="layout-block">
                        {hasFileInput ? (
                            <InputFileBlock
                                title="Input"
                                urlPlaceholder={inputFileUrlPlaceholder}
                                dropText={inputFileDropText}
                                dataRemember="input"
                                dataShare="input"
                                dataAutoUpdate={true}
                            />
                        ) : (
                            <InputBlock 
                                id="input" 
                                title="Input" 
                                placeholder="Enter here..." 
                                dataRemember="input" 
                                dataShare="input" 
                                dataEncodingFrom="#input-type" 
                                dataAutoUpdate={true} 
                                dataToggleMonaco={true} 
                                dataLanguage={editorLanguage}
                            />
                        )}
                        
                        <OutputBlock 
                            id="output" 
                            title="Output" 
                            placeholder={outputPlaceholder || "Output here..."}
                            dataEncodingFrom="#output-type" 
                            dataToggleMonaco={outputToggleMonaco} 
                            dataLanguage={editorLanguage}
                            isReadonly={true}
                            textareaStyle="word-break:break-all;"
                            hasTextarea={hasOutputTextarea}
                        >
                            {!hasFileInput && (
                                <button slot="toolbar" class="icon" id="swap" onclick={`swap('${reverseLink}', [['#output', '#input'], ['#input-type', '#output-type']])`}>
                                    <img src="/images/swap.svg" alt="Swap" title="Swap"/>
                                </button>
                            )}
                            <slot name="before-output-textarea" slot="before-textarea" />
                            <slot name="after-output-textarea" slot="after-textarea" />
                        </OutputBlock>
                    </div>
                    
                    <SettingBlock executeLabel={toolName}>
                        {hasInputSettings && (
                            <div class="setting">
                                <label for="input-type">Input Encoding</label>
                                <InputEncodingSelect id="input-type" dataShare="input_type" dataAutoUpdate={true} />
                            </div>
                        )}
                        
                        {hasOutputSettings && (
                            <div class="setting">
                                <label for="output-type">Output Encoding</label>
                                <OutputEncodingSelect id="output-type" dataShare="output_type" dataAutoUpdate={true} dataType={outputDataType} />
                            </div>
                        )}
                        
                        {hasFormatSettings && (
                            <div class="setting">
                                <label for="format">Format</label>
                                <select id="format" data-remember="format" data-option="format" data-share="format">
                                    <option value="rfc_4648">RFC 4648</option>
                                    <option value="rfc_4648_url_safe">RFC 4648 URL Safe</option>
                                    <option value="rfc_2045">RFC 2045 (MIME)</option>
                                    <option value="rfc_2152">RFC 2152 (UTF-7)</option>
                                    <option value="rfc_3501">RFC 3501 (IMAP)</option>
                                </select>
                            </div>
                        )}

                        <slot name="settings" />
                    </SettingBlock>
                </div>
            </main>
        </div>
    </div>
    
    <script is:inline set:html={`
        ${jsFile ? `
        ++waitLoadCount;
        delayScripts.push({
            src: '/js/${jsFile}',
            onload: function () {
                ${initScript || `console.log('Loaded ${jsFile}');`}
            }
        });
        ` : `
        ${initScript ? `
        ++waitLoadCount;
        delayScripts.push({
            src: '',
            onload: function () {
                ${initScript}
            }
        });
        ` : ''}
        `}
        ${extraJsFile ? `
        ++waitLoadCount;
        delayScripts.push({
            src: '/js/${extraJsFile}',
            onload: function () {
                methodLoad();
            }
        });
        ` : ''}
        ${loadMonaco ? `
        ++waitLoadCount;
        delayScripts.push({
            src: '/js/monaco-editor.js?v=1',
            onload: function () {
                methodLoad();
            }
        });
        ` : ''}
    `}></script>
    <slot name="scripts" />
</BaseLayout>
