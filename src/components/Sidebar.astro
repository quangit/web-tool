---
import { toolSections } from "../data/toolSections";
import { getLangFromUrl, useTranslations } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const { activePage } = Astro.props;

// Helper function to check if a page matches an item URL
function isActiveItem(itemUrl: string, currentPage: string | undefined): boolean {
  if (!currentPage) {return false;}
  // Remove leading/trailing slashes for comparison
  const normalizedUrl = itemUrl.replace(/^\/|\/$/g, "");
  const normalizedPage = currentPage.replace(/^\/|\/$/g, "");
  return normalizedUrl === normalizedPage;
}

// Helper function to check if block should be open/active
function isBlockActive(items: any[], currentPage: string | undefined): boolean {
  if (!currentPage) {return false;}
  return items.some((item) => isActiveItem(item.url, currentPage));
}

const languages = [
  { code: 'en', name: 'English', flag: 'ðŸ‡¬ðŸ‡§' },
  { code: 'vi', name: 'Tiáº¿ng Viá»‡t', flag: 'ðŸ‡»ðŸ‡³' },
  { code: 'zh', name: 'ä¸­æ–‡', flag: 'ðŸ‡¨ðŸ‡³' },
  { code: 'hi', name: 'à¤¹à¤¿à¤‚à¤¦à¥€', flag: 'ðŸ‡®ðŸ‡³' },
  { code: 'es', name: 'EspaÃ±ol', flag: 'ðŸ‡ªðŸ‡¸' },
  { code: 'fr', name: 'FranÃ§ais', flag: 'ðŸ‡«ðŸ‡·' },
  { code: 'pt', name: 'PortuguÃªs', flag: 'ðŸ‡µðŸ‡¹' },
  { code: 'ja', name: 'æ—¥æœ¬èªž', flag: 'ðŸ‡¯ðŸ‡µ' },
];

const currentLang = languages.find(l => l.code === lang) || languages[0];

// Helper to generate language switch URL
function getLangSwitchUrl(targetLang: string) {
  const currentPath = Astro.url.pathname;
  const search = Astro.url.search;

  // Split path into segments
  const segments = currentPath.split('/').filter(Boolean);

  // Remove current language code if it exists at the start
  if (segments.length > 0) {
    const firstSegment = segments[0].replace(/\.html$/, '');
    // Check if the first segment is a valid language code
    const isLanguage = languages.some(l => l.code === firstSegment);
    if (isLanguage) {
      segments.shift();
    }
  }

  // Reconstruct path
  let pathRest = segments.join('/');
  
  // Remove .html extension if present (for static builds)
  pathRest = pathRest.replace(/\.html$/, '');

  let result;
  // Handle root or index
  if (pathRest === '' || pathRest === 'index') {
    result = `/${targetLang}`;
  } else {
    result = `/${targetLang}/${pathRest}`;
  }

  return result + search;
}
---

<div id="sidebar">
  <div class="mask"></div>
  <div class="container">
    <header>
      <a href={`/${lang}`}>
        <h2>{t('sidebar.title')}</h2>
      </a>
      <div class="toolbar">
        <div class="lang-dropdown">
          <button class="lang-btn" id="lang-btn" aria-haspopup="true" aria-expanded="false">
            <span class="lang-flag">{currentLang.flag}</span>
            <span class="lang-text">{currentLang.code.toUpperCase()}</span>
            <svg class="lang-arrow" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M3 5L6 8L9 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
          </button>
          <div class="lang-menu" id="lang-menu" role="menu">
            {languages.map((l) => (
              <a href={getLangSwitchUrl(l.code)} class={`lang-option ${lang === l.code ? 'active' : ''}`} role="menuitem">
                <span class="lang-flag">{l.flag}</span>
                <span class="lang-name">{l.name}</span>
              </a>
            ))}
          </div>
        </div>
        <button class="icon theme">
          <i class="light" data-lucide="sun" title={t('sidebar.dark_mode')}></i>
          <i class="dark" data-lucide="moon" title={t('sidebar.dark_mode')}></i>
        </button>
      </div>
    </header>

    {
      toolSections.map((section) => (
        <div class="section">
          <h3>{section.title}</h3>
          {section.blocks.map((block) => (
            <details class={isBlockActive(block.items, activePage) ? "active" : ""} open={isBlockActive(block.items, activePage)}>
              <summary>{block.title}</summary>
              <nav>
                <ol>
                  {block.items.map((item) => (
                    <li class={isActiveItem(item.url, activePage) ? "active" : ""}>
                      <a href={`/${lang}/${item.url}`}>{item.name}</a>
                    </li>
                  ))}
                </ol>
              </nav>
            </details>
          ))}
        </div>
      ))
    }
  </div>
</div>

<script is:inline>
  // Language Dropdown Toggle
  (function () {
    const langBtn = document.getElementById("lang-btn");
    const langMenu = document.getElementById("lang-menu");

    if (langBtn && langMenu) {
      langBtn.addEventListener("click", function (e) {
        e.stopPropagation();
        const isExpanded = langBtn.getAttribute("aria-expanded") === "true";
        langBtn.setAttribute("aria-expanded", !isExpanded);
        langMenu.classList.toggle("show");
      });

      // Close dropdown when clicking outside
      document.addEventListener("click", function (e) {
        if (!langBtn.contains(e.target) && !langMenu.contains(e.target)) {
          langBtn.setAttribute("aria-expanded", "false");
          langMenu.classList.remove("show");
        }
      });

      // Close dropdown on Escape
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          langBtn.setAttribute("aria-expanded", "false");
          langMenu.classList.remove("show");
        }
      });
    }
  })();
</script>
