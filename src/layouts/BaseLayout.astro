---
const { title, description } = Astro.props;

// Get current URL and language from Astro
const canonicalURL = new URL(Astro.url.pathname, Astro.site).href;
const pathSegments = Astro.url.pathname.split('/').filter(Boolean);
const currentLang = pathSegments[0] || 'en';

// Supported languages
const languages = ['en', 'vi', 'zh', 'hi', 'es', 'fr', 'pt', 'ja'];
const langNames = {
  en: 'en_US',
  vi: 'vi_VN',
  zh: 'zh_CN',
  hi: 'hi_IN',
  es: 'es_ES',
  fr: 'fr_FR',
  pt: 'pt_BR',
  ja: 'ja_JP',
};

// Get language-specific locale for og:locale
const ogLocale = langNames[currentLang as keyof typeof langNames] || 'en_US';

// Generate alternate language URLs
const alternateUrls = languages.map((lang) => {
  const path = Astro.url.pathname.replace(/^\/(en|vi|zh|hi|es|fr|pt|ja)/, `/${lang}`);
  return {
    lang,
    url: new URL(path, Astro.site).href,
  };
});

// Default description
const defaultDescription =
  'Online tools offer many functions for hashing, encoding, decoding, encryption, decryption, formatting, generating and so on. Examples include MD5, SHA-256, SHA-512, SHA-3, Keccak, Base64, Base32, JSON, XML, and QR code related tools.';

const pageTitle = title || 'Web Tools';
const pageDescription = description || defaultDescription;
---

<!doctype html>
<html lang={currentLang}>
  <head>
    <!-- Google tag (gtag.js) -->
    <script is:inline async src="https://www.googletagmanager.com/gtag/js?id=AW-17852180684"
    ></script>
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'AW-17852180684');
    </script>
    <meta charset="UTF-8" />
    <meta http-equiv="content-language" content={currentLang} />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#3b82f6" />
    <title>{pageTitle}</title>
    <meta
      name="keywords"
      content="online,md5,sha1,sha256,sha,sha512,sha3,keccak,shake,base64,base32,syntax highlight,crc-32,crc-16,md2,md4,htmlencode,htmldecode,urlencode,urldecode,json,xml,qr code,free,privacy,client-side,cryptography,hash,encode,decode,encryption"
    />
    <meta name="author" content="webtool" />
    <meta name="copyright" content="webtool" />
    <meta name="description" content={pageDescription} />
    <meta
      name="robots"
      content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"
    />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:site_name" content="Web Tools" />
    <meta property="og:description" content={pageDescription} />
    <meta property="og:locale" content={ogLocale} />
    {
      languages
        .filter((lang) => lang !== currentLang)
        .map((lang) => (
          <meta
            property="og:locale:alternate"
            content={langNames[lang as keyof typeof langNames]}
          />
        ))
    }
    <meta property="og:image" content="https://webtool.center/images/logo.png" />
    <meta property="og:image:width" content="512" />
    <meta property="og:image:height" content="512" />
    <meta property="og:image:type" content="image/png" />
    <meta property="article:author" content="webtool" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={pageDescription} />
    <meta name="twitter:image" content="https://webtool.center/images/logo.png" />

    <!-- Canonical URL -->
    <link rel="canonical" href={canonicalURL} />

    <!-- Alternate language versions -->
    {alternateUrls.map(({ lang, url }) => <link rel="alternate" hreflang={lang} href={url} />)}
    <link rel="alternate" hreflang="x-default" href={alternateUrls[0].url} />

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />

    <!-- Favicon -->
    <link rel="icon" href="/images/logo.ico" />
    <link rel="apple-touch-icon" href="/images/logo.png" />

    <!-- Preconnect to external domains for better performance -->
    <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin />
    <link rel="preconnect" href="https://unpkg.com" crossorigin />
    <link rel="dns-prefetch" href="https://code.jquery.com" />

    <!-- Preload critical resources (version must match actual resource links below) -->
    <link rel="preload" href="/css/style.css?v=27" as="style" />

    <!-- Structured Data (JSON-LD) -->
    <script
      type="application/ld+json"
      set:html={JSON.stringify({
        '@context': 'https://schema.org',
        '@type': 'WebSite',
        name: 'Web Tools',
        description: pageDescription,
        url: 'https://webtool.center',
        potentialAction: {
          '@type': 'SearchAction',
          target: {
            '@type': 'EntryPoint',
            urlTemplate: 'https://webtool.center/?search={search_term_string}',
          },
          'query-input': 'required name=search_term_string',
        },
        inLanguage: languages,
        publisher: {
          '@type': 'Organization',
          name: 'Web Tools',
          logo: {
            '@type': 'ImageObject',
            url: 'https://webtool.center/images/logo.png',
          },
        },
      })}
    />

    <!-- Additional head content from child components -->
    <slot name="head-extra" />

    <script is:inline>
      var delayScripts = [];
      var waitLoadCount = 0;
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      if (location.hostname !== 'localhost') {
        gtag('js', new Date());
        gtag('config', 'G-5FCSDZEKE9');

        (function () {
          var gaUrl = 'https://www.googletagmanager.com/gtag/js?id=G-5FCSDZEKE9';

          function initGTMOnEvent(e) {
            document.removeEventListener(e.type, initGTMOnEvent);
            initGTM();
          }

          function initGTM() {
            if (window.gtmDidInit) {
              return;
            }
            window.gtmDidInit = true;
            var script = document.createElement('script');
            script.async = true;
            script.src = gaUrl;
            document.head.appendChild(script);
          }

          if (document.addEventListener) {
            document.addEventListener('DOMContentLoaded', function () {
              setTimeout(initGTM, 3500);
            });
            document.addEventListener('scroll', initGTMOnEvent, { once: true, passive: true });
            document.addEventListener('mousemove', initGTMOnEvent, { once: true, passive: true });
            document.addEventListener('touchstart', initGTMOnEvent, { once: true, passive: true });
          } else {
            delayScripts.push({
              src: gaUrl,
            });
          }
        })();
      }

      // Apply dark theme before render to prevent flash
      try {
        if (localStorage.getItem('DARK') === '1') {
          document.documentElement.classList.add('dark-theme');
        }
      } catch (e) {
        // Handle localStorage errors silently
      }
    </script>
    <link rel="stylesheet" href="/css/style.css?v=27" />
    <script is:inline src="https://unpkg.com/lucide@latest" defer crossorigin="anonymous"></script>
    <slot name="head-css" />
  </head>
  <body>
    <div id="message"></div>
    <slot />
    <script is:inline src="https://code.jquery.com/jquery-1.10.1.min.js" defer></script>
    <script is:inline src="/js/main.js?v=41" defer></script>
    <script is:inline>
      document.addEventListener('DOMContentLoaded', () => {
        if (window.lucide) {
          window.lucide.createIcons();
        }
      });
    </script>
  </body>
</html>
